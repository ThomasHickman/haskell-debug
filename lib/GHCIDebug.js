"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cp = require("child_process");
const os = require("os");
const path = require("path");
const atomAPI = require("atom");
class GHCIDebug {
    constructor(ghciCommand = 'ghci', ghciArgs = [], folder) {
        this.emitter = new atomAPI.Emitter();
        this.on = this.emitter.on.bind(this.emitter);
        this.ignoreErrors = false;
        this.currentStderrOutput = '';
        this.currentCommandBuffer = '';
        this.commands = [];
        this.commandFinishedString = 'command_finish_o4uB1whagteqE8xBq9oq';
        this.moduleNameByPath = new Map();
        this.ghciCmd = cp.spawn(ghciCommand, ghciArgs, { cwd: folder, shell: true });
        this.ghciCmd.on('exit', () => {
            this.emitter.emit('debug-finished', undefined);
        });
        this.stdout = this.ghciCmd.stdout;
        this.stdin = this.ghciCmd.stdin;
        this.stderr = this.ghciCmd.stderr;
        this.stdout.on('readable', () => this.onStdoutReadable());
        this.stderr.on('readable', () => this.onStderrReadable());
        this.addReadyEvent();
        this.startText = this.run(`:set prompt "%s> ${this.commandFinishedString}"`, false, false, false, true);
    }
    destroy() {
        this.stop();
    }
    async loadModule(name) {
        const cwd = path.dirname(name);
        await this.run(`:cd ${cwd}`);
        await this.run(`:load ${name}`);
    }
    async setExceptionBreakLevel(level) {
        await this.run(':unset -fbreak-on-exception');
        await this.run(':unset -fbreak-on-error');
        switch (level) {
            case 'exceptions':
                await this.run(':set -fbreak-on-exception');
                break;
            case 'errors':
                await this.run(':set -fbreak-on-error');
                break;
            case 'none':
                break;
        }
    }
    async addBreakpoint(breakpoint) {
        if (typeof breakpoint === 'string') {
            await this.run(`:break ${breakpoint}`);
        }
        else if (breakpoint.file) {
            try {
                const moduleName = await this.moduleNameFromFilePath(breakpoint.file);
                await this.run(`:break ${moduleName} ${breakpoint.line}`);
            }
            catch (e) {
                atom.notifications.addError(`Failed to set breakpoint on ${breakpoint.file}`, {
                    detail: e.toString(),
                    stack: e.stack,
                    dismissable: true,
                });
            }
        }
        else {
            atom.notifications.addError('Failed to set breakpoint', {
                detail: 'Text editor has no filename',
                dismissable: true,
            });
        }
    }
    async resolveExpression(expression) {
        if (!expression.trim()) {
            return undefined;
        }
        if (expression.indexOf('\n') !== -1) {
            return undefined;
        }
        const getExpression = (ghciOutput) => {
            const matchResult = ghciOutput.match(/[^ ]* = (.*)/);
            if (!matchResult) {
                return undefined;
            }
            return matchResult[1];
        };
        this.ignoreErrors = true;
        try {
            const printingResult = getExpression(await this.run(`:print ${expression}`, false, false, false));
            if (printingResult !== undefined) {
                return printingResult;
            }
            let tempVarNum = 0;
            let potentialTempVar;
            do {
                tempVarNum += 1;
                potentialTempVar = getExpression(await this.run(`:print temp${tempVarNum}`, false, false, false));
            } while (potentialTempVar !== undefined);
            await this.run(`let temp${tempVarNum} = ${expression}`, false, false, false);
            return getExpression(await this.run(`:print temp${tempVarNum}`, false, false, false));
        }
        finally {
            this.ignoreErrors = false;
        }
    }
    forward() {
        this.run(':forward', true);
    }
    back() {
        this.run(':back', true);
    }
    step() {
        this.run(':step', true, true);
    }
    stop() {
        this.run(':quit');
        setTimeout(() => {
            this.ghciCmd.kill();
        }, 3000);
    }
    continue() {
        this.run(':continue', true);
    }
    async addedAllListeners() {
        return this.startText.then((text) => {
            const firstPrompt = text.indexOf('> ');
            this.emitter.emit('console-output', text.slice(0, firstPrompt + 2));
        });
    }
    async startDebug(moduleName) {
        moduleName = moduleName || 'main';
        await this.run(':trace ' + moduleName, true, true);
    }
    async run(commandText, emitStatusChanges = false, emitHistoryLength = false, emitCommandOutput = true, fulfilWithPrompt = false) {
        const shiftAndRunCommand = () => {
            const command = this.commands.shift();
            this.currentCommand = command;
            if (command) {
                if (command.emitCommandOutput) {
                    this.emitter.emit('command-issued', command.text);
                }
                this.stdin.write(command.text + os.EOL);
            }
        };
        const p = new Promise((fulfil) => {
            const command = {
                text: commandText,
                emitCommandOutput,
                fulfilWithPrompt,
                onFinish: async (output) => {
                    this.currentCommand = undefined;
                    function _fulfil(noPrompt) {
                        if (fulfilWithPrompt) {
                            fulfil(output);
                        }
                        else {
                            fulfil(noPrompt);
                        }
                    }
                    const lastEndOfLinePos = output.lastIndexOf(os.EOL);
                    if (lastEndOfLinePos === -1) {
                        if (emitStatusChanges) {
                            await this.emitStatusChanges(output, '', emitHistoryLength);
                        }
                        _fulfil('');
                    }
                    else {
                        const promptBeginPosition = lastEndOfLinePos + os.EOL.length;
                        if (emitStatusChanges) {
                            await this.emitStatusChanges(output.slice(promptBeginPosition, output.length), output.slice(0, lastEndOfLinePos), emitHistoryLength);
                        }
                        _fulfil(output.slice(0, lastEndOfLinePos));
                    }
                },
            };
            this.commands.push(command);
            if (this.currentCommand === undefined) {
                shiftAndRunCommand();
            }
        });
        p.then(() => {
            if (this.commands.length !== 0) {
                shiftAndRunCommand();
            }
        }).catch((e) => {
            atom.notifications.addError('An error happened', {
                detail: e.toString(),
                stack: e.stack,
                dismissable: true,
            });
        });
        return p;
    }
    addReadyEvent() {
        const eventSubs = [
            'paused-on-exception',
            'line-changed',
            'debug-finished',
        ];
        for (const eventName of eventSubs) {
            this.emitter.on(eventName, () => this.emitter.emit('ready', undefined));
        }
    }
    async getBindings() {
        const outputStr = await this.run(':show bindings', false, false, false);
        return outputStr.split(os.EOL);
    }
    async getHistoryLength() {
        const historyQuery = await this.run(':history 100', false, false, false);
        const regex = /-(\d*).*(?:\n|\r|\r\n)<end of history>$/;
        const matchResult = historyQuery.match(regex);
        if (!matchResult) {
            if (historyQuery.slice(-3) === '...') {
                return Infinity;
            }
            else {
                return 0;
            }
        }
        else {
            return parseInt(matchResult[1], 10);
        }
    }
    parsePrompt(stdOutput) {
        const patterns = [{
                pattern: /\[(?:[-\d]*: )?(.*):\((\d+),(\d+)\)-\((\d+),(\d+)\).*\].*> $/,
                func: (match) => ({
                    filename: match[1],
                    range: [[parseInt(match[2], 10) - 1, parseInt(match[3], 10) - 1],
                        [parseInt(match[4], 10), parseInt(match[5], 10)]],
                }),
            }, {
                pattern: /\[(?:[-\d]*: )?(.*):(\d*):(\d*)-(\d*)\].*> $/,
                func: (match) => ({
                    filename: match[1],
                    range: [[parseInt(match[2], 10) - 1, parseInt(match[3], 10) - 1],
                        [parseInt(match[2], 10) - 1, parseInt(match[4], 10)]],
                }),
            }, {
                pattern: /\[<exception thrown>\].*> $/,
                func: () => GHCIDebug.pausedOnError,
            }, {
                pattern: /.*> $/,
                func: () => GHCIDebug.finishedDebugging,
            }];
        for (const pattern of patterns) {
            const matchResult = stdOutput.match(pattern.pattern);
            if (matchResult) {
                return pattern.func(matchResult);
            }
        }
        throw new Error('Cannot read prompt: \n' + stdOutput);
    }
    async emitStatusChanges(prompt, mainBody, emitHistoryLength) {
        const result = this.parsePrompt(prompt);
        if (result === GHCIDebug.pausedOnError) {
            const historyLength = await this.getHistoryLength();
            this.emitter.emit('paused-on-exception', {
                historyLength,
                localBindings: mainBody.split('\n').slice(1),
            });
        }
        else if (result === GHCIDebug.finishedDebugging) {
            this.emitter.emit('debug-finished', undefined);
        }
        else {
            const breakInfo = result;
            breakInfo.localBindings = await this.getBindings();
            if (emitHistoryLength) {
                breakInfo.historyLength = await this.getHistoryLength();
            }
            this.emitter.emit('line-changed', breakInfo);
        }
    }
    onStderrReadable() {
        const stderrOutput = this.stderr.read();
        if (!stderrOutput || this.ignoreErrors) {
            return;
        }
        this.emitter.emit('error', stderrOutput.toString());
        if (this.currentStderrOutput === '') {
            const disp = this.emitter.on('ready', () => {
                this.emitter.emit('error-completed', this.currentStderrOutput);
                this.currentStderrOutput = '';
                disp.dispose();
            });
        }
        this.currentStderrOutput += stderrOutput.toString();
    }
    onStdoutReadable() {
        const currentString = (this.stdout.read() || '').toString();
        this.currentCommandBuffer += currentString;
        const finishStringPosition = this.currentCommandBuffer.search(this.commandFinishedString);
        if (finishStringPosition !== -1) {
            const outputString = this.currentCommandBuffer.slice(0, finishStringPosition);
            if (this.currentCommand) {
                if (this.currentCommand.emitCommandOutput) {
                    this.emitter.emit('console-output', outputString);
                }
                this.currentCommand.onFinish(outputString);
            }
            this.currentCommandBuffer = this.currentCommandBuffer.slice(finishStringPosition + this.commandFinishedString.length);
            this.onStdoutReadable();
        }
    }
    async moduleNameFromFilePath(filePath) {
        const cachedModuleName = this.moduleNameByPath.get(filePath);
        if (cachedModuleName)
            return cachedModuleName;
        const modules = (await this.run(':show modules')).split(os.EOL);
        const regex = /^([^ ]+) +\( +(.+), +\w+ +\)$/;
        for (const moduleStr of modules) {
            const matchResult = regex.exec(moduleStr);
            if (matchResult) {
                this.moduleNameByPath.set(matchResult[2], matchResult[1]);
            }
            else {
                console.error(`Unexpected reply from GHCI ':show modules': ${moduleStr}`);
            }
        }
        const newCachedModuleName = this.moduleNameByPath.get(filePath);
        if (newCachedModuleName) {
            return newCachedModuleName;
        }
        else {
            throw new Error(`Couldn't find module name for ${filePath}`);
        }
    }
}
GHCIDebug.pausedOnError = Symbol('Paused on Error');
GHCIDebug.finishedDebugging = Symbol('Finished debugging');
exports.GHCIDebug = GHCIDebug;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR0hDSURlYnVnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2xpYi9HSENJRGVidWcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxvQ0FBb0M7QUFFcEMseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUM3QixnQ0FBZ0M7QUE0QmhDO0lBK0JFLFlBQVksV0FBVyxHQUFHLE1BQU0sRUFBRSxXQUFxQixFQUFFLEVBQUUsTUFBZTtRQTNCbEUsWUFBTyxHQVVWLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBRVYsT0FBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFPL0MsaUJBQVksR0FBRyxLQUFLLENBQUE7UUFDcEIsd0JBQW1CLEdBQUcsRUFBRSxDQUFBO1FBQ3hCLHlCQUFvQixHQUFHLEVBQUUsQ0FBQTtRQUN6QixhQUFRLEdBQUcsRUFBZSxDQUFBO1FBRTFCLDBCQUFxQixHQUFHLHFDQUFxQyxDQUFBO1FBQzdELHFCQUFnQixHQUF3QixJQUFJLEdBQUcsRUFBRSxDQUFBO1FBSXZELElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsUUFBUSxFQUFFLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQTtRQUU1RSxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFO1lBQzNCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLFNBQVMsQ0FBQyxDQUFBO1FBQ2hELENBQUMsQ0FBQyxDQUFBO1FBRUYsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQTtRQUNqQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFB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aW1wb3J0IGNwID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpXG5pbXBvcnQgc3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJylcbmltcG9ydCBvcyA9IHJlcXVpcmUoJ29zJylcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5pbXBvcnQgYXRvbUFQSSA9IHJlcXVpcmUoJ2F0b20nKVxuXG5leHBvcnQgaW50ZXJmYWNlIEJyZWFrSW5mbyB7XG4gIGZpbGVuYW1lOiBzdHJpbmdcbiAgcmFuZ2U6IFtbbnVtYmVyLCBudW1iZXJdLCBbbnVtYmVyLCBudW1iZXJdXVxuICBoaXN0b3J5TGVuZ3RoPzogbnVtYmVyXG4gIGxvY2FsQmluZGluZ3M6IHN0cmluZ1tdXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXhjZXB0aW9uSW5mbyB7XG4gIGhpc3RvcnlMZW5ndGg6IG51bWJlclxuICBsb2NhbEJpbmRpbmdzOiBzdHJpbmdbXVxufVxuXG5pbnRlcmZhY2UgQ29tbWFuZCB7XG4gIHRleHQ6IHN0cmluZ1xuICBlbWl0Q29tbWFuZE91dHB1dDogYm9vbGVhblxuICBmdWxmaWxXaXRoUHJvbXB0OiBib29sZWFuXG4gIG9uRmluaXNoOiAob3V0cHV0OiBzdHJpbmcpID0+IGFueVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJyZWFrcG9pbnQge1xuICBsaW5lOiBudW1iZXIgLy8gMSBpcyB0aGUgZ3JlYXRlc3QgbnVtYmVyIHRoaXMgY2FuIGNvbnRhaW5cbiAgZmlsZTogc3RyaW5nIHwgdW5kZWZpbmVkIC8vIGFic29sdXRlIHBhdGhcbn1cblxuZXhwb3J0IHR5cGUgRXhjZXB0aW9uQnJlYWtMZXZlbHMgPSAnbm9uZScgfCAnZXhjZXB0aW9ucycgfCAnZXJyb3JzJ1xuXG5leHBvcnQgY2xhc3MgR0hDSURlYnVnIHtcbiAgcHJpdmF0ZSBzdGF0aWMgcGF1c2VkT25FcnJvciA9IFN5bWJvbCgnUGF1c2VkIG9uIEVycm9yJylcbiAgcHJpdmF0ZSBzdGF0aWMgZmluaXNoZWREZWJ1Z2dpbmcgPSBTeW1ib2woJ0ZpbmlzaGVkIGRlYnVnZ2luZycpXG5cbiAgcHJpdmF0ZSBlbWl0dGVyOiBhdG9tQVBJLkVtaXR0ZXI8e1xuICAgICdkZWJ1Zy1maW5pc2hlZCc6IHVuZGVmaW5lZCAvLy8gRW1taXRlZCB3aGVuIHRoZSBkZWJ1Z2dlciBoYXMgcmVhY2hlZCB0aGUgZW5kIG9mIHRoZSBwcm9ncmFtXG4gICAgJ3JlYWR5JzogRXhjZXB0aW9uSW5mbyB8IHVuZGVmaW5lZCAvLy8gRW1taXRlZCB3aGVuIGdoY2kgaGFzIGp1c3Qgc3RvcHBlZCBleGVjdXRpbmcgYSBjb21tYW5kXG4gIH0sIHtcbiAgICAncGF1c2VkLW9uLWV4Y2VwdGlvbic6IEV4Y2VwdGlvbkluZm8gLy8vIEVtbWl0ZWQgd2hlbiB0aGUgZGVidWdnZXIgaXMgYXQgYW4gZXhjZXB0aW9uXG4gICAgJ2Vycm9yJzogc3RyaW5nIC8vLyBFbW1pdGVkIHdoZW4gc3RkZXJyIGhhcyBpbnB1dFxuICAgICdlcnJvci1jb21wbGV0ZWQnOiBzdHJpbmcgLy8vIEVtbWl0ZWQgd2hlbiBnaGNpIHJlcG9ydHMgYW4gZXJyb3IgZm9yIGEgZ2l2ZW4gY29tbWFuZFxuICAgICdsaW5lLWNoYW5nZWQnOiBCcmVha0luZm8gLy8vIEVtbWl0ZWQgd2hlbiB0aGUgbGluZSB0aGF0IHRoZSBkZWJ1Z2dlciBpcyBvbiBjaGFuZ2VzXG4gICAgJ2NvbnNvbGUtb3V0cHV0Jzogc3RyaW5nIC8vLyBFbW1pdGVkIHdoZW4gdGhlIGdoY2kgaGFzIG91dHB1dGVkIHNvbWV0aGluZyB0byBzdGRvdXQsIGV4Y2x1ZGluZyB0aGUgZXh0cmEgcHJvbXB0XG4gICAgJ2NvbW1hbmQtaXNzdWVkJzogc3RyaW5nIC8vLyBFbW1pdGVkIHdoZW4gYSBjb21tYW5kIGhhcyBiZWVuIGV4ZWN1dGVkXG4gIH0+ID0gbmV3IGF0b21BUEkuRW1pdHRlcigpXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWVtYmVyLW9yZGVyaW5nXG4gIHB1YmxpYyByZWFkb25seSBvbiA9IHRoaXMuZW1pdHRlci5vbi5iaW5kKHRoaXMuZW1pdHRlcilcblxuICBwcml2YXRlIGdoY2lDbWQ6IGNwLkNoaWxkUHJvY2Vzc1xuICBwcml2YXRlIHN0ZG91dDogc3RyZWFtLlJlYWRhYmxlXG4gIHByaXZhdGUgc3RkaW46IHN0cmVhbS5Xcml0YWJsZVxuICBwcml2YXRlIHN0ZGVycjogc3RyZWFtLlJlYWRhYmxlXG4gIHByaXZhdGUgc3RhcnRUZXh0OiBQcm9taXNlPHN0cmluZz5cbiAgcHJpdmF0ZSBpZ25vcmVFcnJvcnMgPSBmYWxzZVxuICBwcml2YXRlIGN1cnJlbnRTdGRlcnJPdXRwdXQgPSAnJ1xuICBwcml2YXRlIGN1cnJlbnRDb21tYW5kQnVmZmVyID0gJydcbiAgcHJpdmF0ZSBjb21tYW5kcyA9IFtdIGFzIENvbW1hbmRbXVxuICBwcml2YXRlIGN1cnJlbnRDb21tYW5kPzogQ29tbWFuZFxuICBwcml2YXRlIGNvbW1hbmRGaW5pc2hlZFN0cmluZyA9ICdjb21tYW5kX2ZpbmlzaF9vNHVCMXdoYWd0ZXFFOHhCcTlvcSdcbiAgcHJpdmF0ZSBtb2R1bGVOYW1lQnlQYXRoOiBNYXA8c3RyaW5nLCBzdHJpbmc+ID0gbmV3IE1hcCgpXG5cbiAgY29uc3RydWN0b3IoZ2hjaUNvbW1hbmQgPSAnZ2hjaScsIGdoY2lBcmdzOiBzdHJpbmdbXSA9IFtdLCBmb2xkZXI/OiBzdHJpbmcpIHtcblxuICAgIHRoaXMuZ2hjaUNtZCA9IGNwLnNwYXduKGdoY2lDb21tYW5kLCBnaGNpQXJncywgeyBjd2Q6IGZvbGRlciwgc2hlbGw6IHRydWUgfSlcblxuICAgIHRoaXMuZ2hjaUNtZC5vbignZXhpdCcsICgpID0+IHtcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkZWJ1Zy1maW5pc2hlZCcsIHVuZGVmaW5lZClcbiAgICB9KVxuXG4gICAgdGhpcy5zdGRvdXQgPSB0aGlzLmdoY2lDbWQuc3Rkb3V0XG4gICAgdGhpcy5zdGRpbiA9IHRoaXMuZ2hjaUNtZC5zdGRpblxuICAgIHRoaXMuc3RkZXJyID0gdGhpcy5naGNpQ21kLnN0ZGVyclxuICAgIHRoaXMuc3Rkb3V0Lm9uKCdyZWFkYWJsZScsICgpID0+IHRoaXMub25TdGRvdXRSZWFkYWJsZSgpKVxuICAgIHRoaXMuc3RkZXJyLm9uKCdyZWFkYWJsZScsICgpID0+IHRoaXMub25TdGRlcnJSZWFkYWJsZSgpKVxuXG4gICAgdGhpcy5hZGRSZWFkeUV2ZW50KClcblxuICAgIHRoaXMuc3RhcnRUZXh0ID0gdGhpcy5ydW4oYDpzZXQgcHJvbXB0IFwiJXM+ICR7dGhpcy5jb21tYW5kRmluaXNoZWRTdHJpbmd9XCJgLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCB0cnVlKVxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5zdG9wKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsb2FkTW9kdWxlKG5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IGN3ZCA9IHBhdGguZGlybmFtZShuYW1lKVxuXG4gICAgYXdhaXQgdGhpcy5ydW4oYDpjZCAke2N3ZH1gKVxuICAgIGF3YWl0IHRoaXMucnVuKGA6bG9hZCAke25hbWV9YClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZXRFeGNlcHRpb25CcmVha0xldmVsKGxldmVsOiBFeGNlcHRpb25CcmVha0xldmVscykge1xuICAgIGF3YWl0IHRoaXMucnVuKCc6dW5zZXQgLWZicmVhay1vbi1leGNlcHRpb24nKVxuICAgIGF3YWl0IHRoaXMucnVuKCc6dW5zZXQgLWZicmVhay1vbi1lcnJvcicpXG5cbiAgICBzd2l0Y2ggKGxldmVsKSB7XG4gICAgICBjYXNlICdleGNlcHRpb25zJzpcbiAgICAgICAgYXdhaXQgdGhpcy5ydW4oJzpzZXQgLWZicmVhay1vbi1leGNlcHRpb24nKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAnZXJyb3JzJzpcbiAgICAgICAgYXdhaXQgdGhpcy5ydW4oJzpzZXQgLWZicmVhay1vbi1lcnJvcicpXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlICdub25lJzogLy8gbm8tb3BcbiAgICAgICAgYnJlYWtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYWRkQnJlYWtwb2ludChicmVha3BvaW50OiBCcmVha3BvaW50IHwgc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHR5cGVvZiBicmVha3BvaW50ID09PSAnc3RyaW5nJykge1xuICAgICAgYXdhaXQgdGhpcy5ydW4oYDpicmVhayAke2JyZWFrcG9pbnR9YClcbiAgICB9IGVsc2UgaWYgKGJyZWFrcG9pbnQuZmlsZSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgbW9kdWxlTmFtZTogc3RyaW5nID0gYXdhaXQgdGhpcy5tb2R1bGVOYW1lRnJvbUZpbGVQYXRoKGJyZWFrcG9pbnQuZmlsZSlcbiAgICAgICAgYXdhaXQgdGhpcy5ydW4oYDpicmVhayAke21vZHVsZU5hbWV9ICR7YnJlYWtwb2ludC5saW5lfWApXG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihgRmFpbGVkIHRvIHNldCBicmVha3BvaW50IG9uICR7YnJlYWtwb2ludC5maWxlfWAsIHtcbiAgICAgICAgICBkZXRhaWw6IChlIGFzIEVycm9yKS50b1N0cmluZygpLFxuICAgICAgICAgIHN0YWNrOiAoZSBhcyBFcnJvcikuc3RhY2ssXG4gICAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcignRmFpbGVkIHRvIHNldCBicmVha3BvaW50Jywge1xuICAgICAgICBkZXRhaWw6ICdUZXh0IGVkaXRvciBoYXMgbm8gZmlsZW5hbWUnLFxuICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgLyoqIHJlc29sdmVkIHRoZSBnaXZlbiBleHByZXNzaW9uIHVzaW5nIDpwcmludCwgcmV0dXJucyBudWxsIGlmIGl0IGlzIGludmFsaWRcbiAgKi9cbiAgcHVibGljIGFzeW5jIHJlc29sdmVFeHByZXNzaW9uKGV4cHJlc3Npb246IHN0cmluZykge1xuICAgIGlmICghZXhwcmVzc2lvbi50cmltKCkpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICB9XG4gICAgLy8gZXhwcmVzc2lvbnMgY2FuJ3QgaGF2ZSBuZXcgbGluZXNcbiAgICBpZiAoZXhwcmVzc2lvbi5pbmRleE9mKCdcXG4nKSAhPT0gLTEpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICB9XG5cbiAgICBjb25zdCBnZXRFeHByZXNzaW9uID0gKGdoY2lPdXRwdXQ6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgbWF0Y2hSZXN1bHQgPSBnaGNpT3V0cHV0Lm1hdGNoKC9bXiBdKiA9ICguKikvKVxuICAgICAgaWYgKCFtYXRjaFJlc3VsdCkgeyByZXR1cm4gdW5kZWZpbmVkIH1cbiAgICAgIHJldHVybiBtYXRjaFJlc3VsdFsxXVxuICAgIH1cblxuICAgIC8vIGZvciB0aGUgY29kZSBiZWxvdywgaWdub3JlIGVycm9yc1xuICAgIHRoaXMuaWdub3JlRXJyb3JzID0gdHJ1ZVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIHRyeSBwcmludGluZyBleHByZXNzaW9uXG4gICAgICBjb25zdCBwcmludGluZ1Jlc3VsdCA9IGdldEV4cHJlc3Npb24oXG4gICAgICAgIGF3YWl0IHRoaXMucnVuKGA6cHJpbnQgJHtleHByZXNzaW9ufWAsIGZhbHNlLCBmYWxzZSwgZmFsc2UpKVxuICAgICAgaWYgKHByaW50aW5nUmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIHByaW50aW5nUmVzdWx0XG4gICAgICB9XG5cbiAgICAgIC8vIGlmIHRoYXQgZmFpbHMgYXNzaWduIGl0IHRvIGEgdGVtcG9yYXJ5IHZhcmlhYmxlIGFuZCBldmFsdWF0ZSB0aGF0XG4gICAgICBsZXQgdGVtcFZhck51bSA9IDBcbiAgICAgIGxldCBwb3RlbnRpYWxUZW1wVmFyOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICAgIGRvIHtcbiAgICAgICAgdGVtcFZhck51bSArPSAxXG4gICAgICAgIHBvdGVudGlhbFRlbXBWYXIgPSBnZXRFeHByZXNzaW9uKFxuICAgICAgICAgIGF3YWl0IHRoaXMucnVuKGA6cHJpbnQgdGVtcCR7dGVtcFZhck51bX1gLCBmYWxzZSwgZmFsc2UsIGZhbHNlKSlcbiAgICAgIH0gd2hpbGUgKHBvdGVudGlhbFRlbXBWYXIgIT09IHVuZGVmaW5lZClcblxuICAgICAgYXdhaXQgdGhpcy5ydW4oYGxldCB0ZW1wJHt0ZW1wVmFyTnVtfSA9ICR7ZXhwcmVzc2lvbn1gLCBmYWxzZSwgZmFsc2UsIGZhbHNlKVxuICAgICAgcmV0dXJuIGdldEV4cHJlc3Npb24oYXdhaXQgdGhpcy5ydW4oYDpwcmludCB0ZW1wJHt0ZW1wVmFyTnVtfWAsIGZhbHNlLCBmYWxzZSwgZmFsc2UpKVxuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLmlnbm9yZUVycm9ycyA9IGZhbHNlXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGZvcndhcmQoKSB7XG4gICAgdGhpcy5ydW4oJzpmb3J3YXJkJywgdHJ1ZSlcbiAgfVxuXG4gIHB1YmxpYyBiYWNrKCkge1xuICAgIHRoaXMucnVuKCc6YmFjaycsIHRydWUpXG4gIH1cblxuICBwdWJsaWMgc3RlcCgpIHtcbiAgICB0aGlzLnJ1bignOnN0ZXAnLCB0cnVlLCB0cnVlKVxuICB9XG5cbiAgcHVibGljIHN0b3AoKSB7XG4gICAgdGhpcy5ydW4oJzpxdWl0JylcbiAgICBzZXRUaW1lb3V0KFxuICAgICAgKCkgPT4ge1xuICAgICAgICB0aGlzLmdoY2lDbWQua2lsbCgpXG4gICAgICB9LFxuICAgICAgMzAwMClcbiAgfVxuXG4gIHB1YmxpYyBjb250aW51ZSgpIHtcbiAgICB0aGlzLnJ1bignOmNvbnRpbnVlJywgdHJ1ZSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBhZGRlZEFsbExpc3RlbmVycygpIHtcbiAgICByZXR1cm4gdGhpcy5zdGFydFRleHQudGhlbigodGV4dCkgPT4ge1xuICAgICAgY29uc3QgZmlyc3RQcm9tcHQgPSB0ZXh0LmluZGV4T2YoJz4gJylcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdjb25zb2xlLW91dHB1dCcsIHRleHQuc2xpY2UoMCwgZmlyc3RQcm9tcHQgKyAyKSlcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHN0YXJ0RGVidWcobW9kdWxlTmFtZT86IHN0cmluZykge1xuICAgIG1vZHVsZU5hbWUgPSBtb2R1bGVOYW1lIHx8ICdtYWluJ1xuICAgIGF3YWl0IHRoaXMucnVuKCc6dHJhY2UgJyArIG1vZHVsZU5hbWUsIHRydWUsIHRydWUpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcnVuKFxuICAgIGNvbW1hbmRUZXh0OiBzdHJpbmcsXG4gICAgZW1pdFN0YXR1c0NoYW5nZXM6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBlbWl0SGlzdG9yeUxlbmd0aDogYm9vbGVhbiA9IGZhbHNlLFxuICAgIGVtaXRDb21tYW5kT3V0cHV0OiBib29sZWFuID0gdHJ1ZSxcbiAgICBmdWxmaWxXaXRoUHJvbXB0OiBib29sZWFuID0gZmFsc2UsXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3Qgc2hpZnRBbmRSdW5Db21tYW5kID0gKCkgPT4ge1xuICAgICAgY29uc3QgY29tbWFuZCA9IHRoaXMuY29tbWFuZHMuc2hpZnQoKVxuXG4gICAgICB0aGlzLmN1cnJlbnRDb21tYW5kID0gY29tbWFuZFxuXG4gICAgICBpZiAoY29tbWFuZCkge1xuICAgICAgICBpZiAoY29tbWFuZC5lbWl0Q29tbWFuZE91dHB1dCkge1xuICAgICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdjb21tYW5kLWlzc3VlZCcsIGNvbW1hbmQudGV4dClcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc3RkaW4ud3JpdGUoY29tbWFuZC50ZXh0ICsgb3MuRU9MKVxuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHAgPSBuZXcgUHJvbWlzZTxzdHJpbmc+KChmdWxmaWwpID0+IHtcbiAgICAgIGNvbnN0IGNvbW1hbmQ6IENvbW1hbmQgPSB7XG4gICAgICAgIHRleHQ6IGNvbW1hbmRUZXh0LFxuICAgICAgICBlbWl0Q29tbWFuZE91dHB1dCxcbiAgICAgICAgZnVsZmlsV2l0aFByb21wdCxcbiAgICAgICAgb25GaW5pc2g6IGFzeW5jIChvdXRwdXQpID0+IHtcbiAgICAgICAgICB0aGlzLmN1cnJlbnRDb21tYW5kID0gdW5kZWZpbmVkXG5cbiAgICAgICAgICBmdW5jdGlvbiBfZnVsZmlsKG5vUHJvbXB0OiBzdHJpbmcpIHtcbiAgICAgICAgICAgIGlmIChmdWxmaWxXaXRoUHJvbXB0KSB7XG4gICAgICAgICAgICAgIGZ1bGZpbChvdXRwdXQpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBmdWxmaWwobm9Qcm9tcHQpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgbGFzdEVuZE9mTGluZVBvcyA9IG91dHB1dC5sYXN0SW5kZXhPZihvcy5FT0wpXG5cbiAgICAgICAgICBpZiAobGFzdEVuZE9mTGluZVBvcyA9PT0gLTEpIHtcbiAgICAgICAgICAgIC8qaS5lLiBubyBvdXRwdXQgaGFzIGJlZW4gcHJvZHVjZWQqL1xuICAgICAgICAgICAgaWYgKGVtaXRTdGF0dXNDaGFuZ2VzKSB7XG4gICAgICAgICAgICAgIGF3YWl0IHRoaXMuZW1pdFN0YXR1c0NoYW5nZXMob3V0cHV0LCAnJywgZW1pdEhpc3RvcnlMZW5ndGgpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBfZnVsZmlsKCcnKVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBwcm9tcHRCZWdpblBvc2l0aW9uID0gbGFzdEVuZE9mTGluZVBvcyArIG9zLkVPTC5sZW5ndGhcblxuICAgICAgICAgICAgaWYgKGVtaXRTdGF0dXNDaGFuZ2VzKSB7XG4gICAgICAgICAgICAgIGF3YWl0IHRoaXMuZW1pdFN0YXR1c0NoYW5nZXMoXG4gICAgICAgICAgICAgICAgb3V0cHV0LnNsaWNlKHByb21wdEJlZ2luUG9zaXRpb24sIG91dHB1dC5sZW5ndGgpLFxuICAgICAgICAgICAgICAgIG91dHB1dC5zbGljZSgwLCBsYXN0RW5kT2ZMaW5lUG9zKSxcbiAgICAgICAgICAgICAgICBlbWl0SGlzdG9yeUxlbmd0aCxcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgX2Z1bGZpbChvdXRwdXQuc2xpY2UoMCwgbGFzdEVuZE9mTGluZVBvcykpXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgfVxuXG4gICAgICB0aGlzLmNvbW1hbmRzLnB1c2goY29tbWFuZClcblxuICAgICAgaWYgKHRoaXMuY3VycmVudENvbW1hbmQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBzaGlmdEFuZFJ1bkNvbW1hbmQoKVxuICAgICAgfVxuICAgIH0pXG4gICAgcC50aGVuKCgpID0+IHtcbiAgICAgIGlmICh0aGlzLmNvbW1hbmRzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICBzaGlmdEFuZFJ1bkNvbW1hbmQoKVxuICAgICAgfVxuICAgIH0pLmNhdGNoKChlOiBFcnJvcikgPT4ge1xuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKCdBbiBlcnJvciBoYXBwZW5lZCcsIHtcbiAgICAgICAgZGV0YWlsOiBlLnRvU3RyaW5nKCksXG4gICAgICAgIHN0YWNrOiBlLnN0YWNrLFxuICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgIH0pXG4gICAgfSlcbiAgICByZXR1cm4gcFxuICB9XG5cbiAgcHJpdmF0ZSBhZGRSZWFkeUV2ZW50KCkge1xuICAgIGNvbnN0IGV2ZW50U3VicyA9IFtcbiAgICAgICdwYXVzZWQtb24tZXhjZXB0aW9uJyxcbiAgICAgICdsaW5lLWNoYW5nZWQnLFxuICAgICAgJ2RlYnVnLWZpbmlzaGVkJyxcbiAgICBdXG5cbiAgICBmb3IgKGNvbnN0IGV2ZW50TmFtZSBvZiBldmVudFN1YnMpIHtcbiAgICAgICh0aGlzLmVtaXR0ZXIub24gYXMgYW55KShldmVudE5hbWUsICgpID0+IHRoaXMuZW1pdHRlci5lbWl0KCdyZWFkeScsIHVuZGVmaW5lZCkpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRCaW5kaW5ncygpIHtcbiAgICBjb25zdCBvdXRwdXRTdHIgPSBhd2FpdCB0aGlzLnJ1bignOnNob3cgYmluZGluZ3MnLCBmYWxzZSwgZmFsc2UsIGZhbHNlKVxuICAgIHJldHVybiBvdXRwdXRTdHIuc3BsaXQob3MuRU9MKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRIaXN0b3J5TGVuZ3RoKCkge1xuICAgIGNvbnN0IGhpc3RvcnlRdWVyeSA9IGF3YWl0IHRoaXMucnVuKCc6aGlzdG9yeSAxMDAnLCBmYWxzZSwgZmFsc2UsIGZhbHNlKVxuICAgIGNvbnN0IHJlZ2V4ID0gLy0oXFxkKikuKig/OlxcbnxcXHJ8XFxyXFxuKTxlbmQgb2YgaGlzdG9yeT4kL1xuXG4gICAgY29uc3QgbWF0Y2hSZXN1bHQgPSBoaXN0b3J5UXVlcnkubWF0Y2gocmVnZXgpXG4gICAgaWYgKCFtYXRjaFJlc3VsdCkge1xuICAgICAgaWYgKGhpc3RvcnlRdWVyeS5zbGljZSgtMykgPT09ICcuLi4nKSB7XG4gICAgICAgIHJldHVybiBJbmZpbml0eSAvLyBoaXN0b3J5IGlzIHZlcnkgbG9uZ1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIDBcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHBhcnNlSW50KG1hdGNoUmVzdWx0WzFdLCAxMClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHBhcnNlUHJvbXB0KHN0ZE91dHB1dDogc3RyaW5nKTogQnJlYWtJbmZvIHwgU3ltYm9sIHtcbiAgICBjb25zdCBwYXR0ZXJucyA9IFt7XG4gICAgICBwYXR0ZXJuOiAvXFxbKD86Wy1cXGRdKjogKT8oLiopOlxcKChcXGQrKSwoXFxkKylcXCktXFwoKFxcZCspLChcXGQrKVxcKS4qXFxdLio+ICQvLFxuICAgICAgZnVuYzogKG1hdGNoKSA9PiAoe1xuICAgICAgICBmaWxlbmFtZTogbWF0Y2hbMV0sXG4gICAgICAgIHJhbmdlOiBbW3BhcnNlSW50KG1hdGNoWzJdLCAxMCkgLSAxLCBwYXJzZUludChtYXRjaFszXSwgMTApIC0gMV0sXG4gICAgICAgIFtwYXJzZUludChtYXRjaFs0XSwgMTApLCBwYXJzZUludChtYXRjaFs1XSwgMTApXV0sXG4gICAgICB9KSxcbiAgICB9LCB7XG4gICAgICBwYXR0ZXJuOiAvXFxbKD86Wy1cXGRdKjogKT8oLiopOihcXGQqKTooXFxkKiktKFxcZCopXFxdLio+ICQvLFxuICAgICAgZnVuYzogKG1hdGNoKSA9PiAoe1xuICAgICAgICBmaWxlbmFtZTogbWF0Y2hbMV0sXG4gICAgICAgIHJhbmdlOiBbW3BhcnNlSW50KG1hdGNoWzJdLCAxMCkgLSAxLCBwYXJzZUludChtYXRjaFszXSwgMTApIC0gMV0sXG4gICAgICAgIFtwYXJzZUludChtYXRjaFsyXSwgMTApIC0gMSwgcGFyc2VJbnQobWF0Y2hbNF0sIDEwKV1dLFxuICAgICAgfSksXG4gICAgfSwge1xuICAgICAgcGF0dGVybjogL1xcWzxleGNlcHRpb24gdGhyb3duPlxcXS4qPiAkLyxcbiAgICAgIGZ1bmM6ICgpID0+IEdIQ0lEZWJ1Zy5wYXVzZWRPbkVycm9yLFxuICAgIH0sIHtcbiAgICAgIHBhdHRlcm46IC8uKj4gJC8sXG4gICAgICBmdW5jOiAoKSA9PiBHSENJRGVidWcuZmluaXNoZWREZWJ1Z2dpbmcsXG4gICAgfV0gYXMgQXJyYXk8eyBwYXR0ZXJuOiBSZWdFeHA7IGZ1bmM6IChtYXRjaDogc3RyaW5nW10pID0+IEJyZWFrSW5mbyB8IFN5bWJvbCB9PlxuICAgIGZvciAoY29uc3QgcGF0dGVybiBvZiBwYXR0ZXJucykge1xuICAgICAgY29uc3QgbWF0Y2hSZXN1bHQgPSBzdGRPdXRwdXQubWF0Y2gocGF0dGVybi5wYXR0ZXJuKVxuICAgICAgaWYgKG1hdGNoUmVzdWx0KSB7XG4gICAgICAgIHJldHVybiBwYXR0ZXJuLmZ1bmMobWF0Y2hSZXN1bHQpXG4gICAgICB9XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHJlYWQgcHJvbXB0OiBcXG4nICsgc3RkT3V0cHV0KVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBlbWl0U3RhdHVzQ2hhbmdlcyhwcm9tcHQ6IHN0cmluZywgbWFpbkJvZHk6IHN0cmluZywgZW1pdEhpc3RvcnlMZW5ndGg6IGJvb2xlYW4pIHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLnBhcnNlUHJvbXB0KHByb21wdClcblxuICAgIGlmIChyZXN1bHQgPT09IEdIQ0lEZWJ1Zy5wYXVzZWRPbkVycm9yKSB7XG4gICAgICBjb25zdCBoaXN0b3J5TGVuZ3RoID0gYXdhaXQgdGhpcy5nZXRIaXN0b3J5TGVuZ3RoKClcblxuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ3BhdXNlZC1vbi1leGNlcHRpb24nLCB7XG4gICAgICAgIGhpc3RvcnlMZW5ndGgsXG4gICAgICAgIGxvY2FsQmluZGluZ3M6IG1haW5Cb2R5LnNwbGl0KCdcXG4nKS5zbGljZSgxKSxcbiAgICAgIH0pXG4gICAgfSBlbHNlIGlmIChyZXN1bHQgPT09IEdIQ0lEZWJ1Zy5maW5pc2hlZERlYnVnZ2luZykge1xuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RlYnVnLWZpbmlzaGVkJywgdW5kZWZpbmVkKVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBicmVha0luZm8gPSByZXN1bHQgYXMgQnJlYWtJbmZvXG5cbiAgICAgIGJyZWFrSW5mby5sb2NhbEJpbmRpbmdzID0gYXdhaXQgdGhpcy5nZXRCaW5kaW5ncygpXG5cbiAgICAgIGlmIChlbWl0SGlzdG9yeUxlbmd0aCkge1xuICAgICAgICBicmVha0luZm8uaGlzdG9yeUxlbmd0aCA9IGF3YWl0IHRoaXMuZ2V0SGlzdG9yeUxlbmd0aCgpXG4gICAgICB9XG5cbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdsaW5lLWNoYW5nZWQnLCBicmVha0luZm8pXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvblN0ZGVyclJlYWRhYmxlKCkge1xuICAgIGNvbnN0IHN0ZGVyck91dHB1dCA9IHRoaXMuc3RkZXJyLnJlYWQoKSBhcyBzdHJpbmcgfCBCdWZmZXIgfCBudWxsXG4gICAgaWYgKCFzdGRlcnJPdXRwdXQgfHwgdGhpcy5pZ25vcmVFcnJvcnMpIHtcbiAgICAgIHJldHVybiAvLyB0aGlzIGlzIHRoZSBlbmQgb2YgdGhlIGlucHV0IHN0cmVhbVxuICAgIH1cblxuICAgIHRoaXMuZW1pdHRlci5lbWl0KCdlcnJvcicsIHN0ZGVyck91dHB1dC50b1N0cmluZygpKVxuXG4gICAgaWYgKHRoaXMuY3VycmVudFN0ZGVyck91dHB1dCA9PT0gJycpIHtcbiAgICAgIGNvbnN0IGRpc3AgPSB0aGlzLmVtaXR0ZXIub24oJ3JlYWR5JywgKCkgPT4ge1xuICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZXJyb3ItY29tcGxldGVkJywgdGhpcy5jdXJyZW50U3RkZXJyT3V0cHV0KVxuICAgICAgICB0aGlzLmN1cnJlbnRTdGRlcnJPdXRwdXQgPSAnJ1xuICAgICAgICBkaXNwLmRpc3Bvc2UoKVxuICAgICAgfSlcbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRTdGRlcnJPdXRwdXQgKz0gc3RkZXJyT3V0cHV0LnRvU3RyaW5nKClcbiAgfVxuXG4gIHByaXZhdGUgb25TdGRvdXRSZWFkYWJsZSgpIHtcbiAgICBjb25zdCBjdXJyZW50U3RyaW5nID0gKHRoaXMuc3Rkb3V0LnJlYWQoKSBhcyBzdHJpbmcgfCBCdWZmZXIgfCBudWxsIHx8ICcnKS50b1N0cmluZygpXG5cbiAgICB0aGlzLmN1cnJlbnRDb21tYW5kQnVmZmVyICs9IGN1cnJlbnRTdHJpbmdcblxuICAgIGNvbnN0IGZpbmlzaFN0cmluZ1Bvc2l0aW9uID0gdGhpcy5jdXJyZW50Q29tbWFuZEJ1ZmZlci5zZWFyY2godGhpcy5jb21tYW5kRmluaXNoZWRTdHJpbmcpXG4gICAgaWYgKGZpbmlzaFN0cmluZ1Bvc2l0aW9uICE9PSAtMSkge1xuICAgICAgY29uc3Qgb3V0cHV0U3RyaW5nID0gdGhpcy5jdXJyZW50Q29tbWFuZEJ1ZmZlci5zbGljZSgwLCBmaW5pc2hTdHJpbmdQb3NpdGlvbilcblxuICAgICAgaWYgKHRoaXMuY3VycmVudENvbW1hbmQpIHtcbiAgICAgICAgaWYgKHRoaXMuY3VycmVudENvbW1hbmQuZW1pdENvbW1hbmRPdXRwdXQpIHtcbiAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnY29uc29sZS1vdXRwdXQnLCBvdXRwdXRTdHJpbmcpXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmN1cnJlbnRDb21tYW5kLm9uRmluaXNoKG91dHB1dFN0cmluZylcbiAgICAgIH1cblxuICAgICAgLy8gVGFrZSB0aGUgZmluaXNoZWQgc3RyaW5nIG9mZiB0aGUgYnVmZmVyIGFuZCBwcm9jZXNzIHRoZSBuZXh0IG91cHV0XG4gICAgICB0aGlzLmN1cnJlbnRDb21tYW5kQnVmZmVyID0gdGhpcy5jdXJyZW50Q29tbWFuZEJ1ZmZlci5zbGljZShcbiAgICAgICAgZmluaXNoU3RyaW5nUG9zaXRpb24gKyB0aGlzLmNvbW1hbmRGaW5pc2hlZFN0cmluZy5sZW5ndGgpXG4gICAgICB0aGlzLm9uU3Rkb3V0UmVhZGFibGUoKVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbW9kdWxlTmFtZUZyb21GaWxlUGF0aChmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBjYWNoZWRNb2R1bGVOYW1lID0gdGhpcy5tb2R1bGVOYW1lQnlQYXRoLmdldChmaWxlUGF0aClcbiAgICBpZiAoY2FjaGVkTW9kdWxlTmFtZSkgcmV0dXJuIGNhY2hlZE1vZHVsZU5hbWVcbiAgICBjb25zdCBtb2R1bGVzID0gKGF3YWl0IHRoaXMucnVuKCc6c2hvdyBtb2R1bGVzJykpLnNwbGl0KG9zLkVPTClcbiAgICBjb25zdCByZWdleCA9IC9eKFteIF0rKSArXFwoICsoLispLCArXFx3KyArXFwpJC9cbiAgICBmb3IgKGNvbnN0IG1vZHVsZVN0ciBvZiBtb2R1bGVzKSB7XG4gICAgICBjb25zdCBtYXRjaFJlc3VsdCA9IHJlZ2V4LmV4ZWMobW9kdWxlU3RyKVxuICAgICAgaWYgKG1hdGNoUmVzdWx0KSB7XG4gICAgICAgIHRoaXMubW9kdWxlTmFtZUJ5UGF0aC5zZXQobWF0Y2hSZXN1bHRbMl0sIG1hdGNoUmVzdWx0WzFdKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgVW5leHBlY3RlZCByZXBseSBmcm9tIEdIQ0kgJzpzaG93IG1vZHVsZXMnOiAke21vZHVsZVN0cn1gKVxuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBuZXdDYWNoZWRNb2R1bGVOYW1lID0gdGhpcy5tb2R1bGVOYW1lQnlQYXRoLmdldChmaWxlUGF0aClcbiAgICBpZiAobmV3Q2FjaGVkTW9kdWxlTmFtZSkge1xuICAgICAgcmV0dXJuIG5ld0NhY2hlZE1vZHVsZU5hbWVcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZG4ndCBmaW5kIG1vZHVsZSBuYW1lIGZvciAke2ZpbGVQYXRofWApXG4gICAgfVxuICB9XG59XG4iXX0=