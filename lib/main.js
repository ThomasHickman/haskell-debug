"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Debugger_1 = require("./Debugger");
const BreakpointUI_1 = require("./BreakpointUI");
const TooltipOverride_1 = require("./TooltipOverride");
const atomAPI = require("atom");
const os = require("os");
const path = require("path");
const cp = require("child_process");
const config_1 = require("./config");
const SelectDebugModeView_1 = require("./views/SelectDebugModeView");
var config_2 = require("./config");
exports.config = config_2.config;
const breakpointUI = new BreakpointUI_1.BreakpointUI();
let debuggerInst;
let upi;
let state;
let disposables;
const commands = {
    'debug': async ({ currentTarget }) => {
        const ob = upi && await upi.getOthersConfigParam('ide-haskell-cabal', 'builder');
        if (ob) {
            debuggerInst = new Debugger_1.Debugger(breakpointUI.breakpoints, currentTarget.getModel(), ob.name);
        }
        else {
            debuggerInst = new Debugger_1.Debugger(breakpointUI.breakpoints, currentTarget.getModel());
        }
    },
    'debug-back': () => {
        if (debuggerInst) {
            debuggerInst.back();
        }
    },
    'debug-forward': () => {
        if (debuggerInst) {
            debuggerInst.forward();
        }
    },
    'debug-step': () => {
        if (debuggerInst) {
            debuggerInst.step();
        }
    },
    'debug-stop': () => {
        if (debuggerInst) {
            debuggerInst.stop();
        }
    },
    'debug-continue': () => {
        if (debuggerInst) {
            debuggerInst.continue();
        }
    },
    'toggle-breakpoint': ({ currentTarget }) => {
        breakpointUI.toggleBreakpoint(currentTarget.getModel().getCursorBufferPosition().row + 1, currentTarget.getModel());
    },
    'set-break-on-exception': async () => {
        const result = await SelectDebugModeView_1.selectDebugModeView(config_1.debugModes, atom.config.get('haskell-debug.breakOnException'));
        if (result !== undefined) {
            atom.config.set('haskell-debug.breakOnException', result);
        }
    },
};
function onFirstRun() {
    state = {
        properlyActivated: false,
    };
    const isWin = os.platform().indexOf('win') > -1;
    const where = isWin ? 'where' : 'whereis';
    const out = cp.exec(where + ' node');
    out.on('close', (code) => {
        if (code === 1) {
            atom.config.set('haskell-debug.nodeCommand', path.resolve(atom.packages.getApmPath(), '../../bin/atom'));
            if (state) {
                state.properlyActivated = true;
            }
        }
    });
}
function activePaneObserver(pane) {
    if (atom.workspace.isTextEditor(pane)) {
        const te = pane;
        const scopes = te.getRootScopeDescriptor().getScopesArray();
        if (scopes.length === 1 && scopes[0] === 'source.haskell') {
            if (!te.hasHaskellBreakpoints) {
                breakpointUI.attachToNewTextEditor(te);
                te.hasHaskellBreakpoints = true;
            }
            if (debuggerInst) {
                debuggerInst.showPanels();
            }
            return;
        }
    }
    if (debuggerInst) {
        debuggerInst.hidePanels();
    }
}
function activate(_state) {
    disposables = new atomAPI.CompositeDisposable();
    state = _state;
    if (state === undefined || state.properlyActivated !== true) {
        onFirstRun();
    }
    disposables.add(atom.workspace.observeActivePaneItem(activePaneObserver));
    for (const command of Object.keys(commands)) {
        disposables.add(atom.commands.add("atom-text-editor[data-grammar='source haskell']", 'haskell:' + command, commands[command]));
    }
}
exports.activate = activate;
function deactivate() {
    disposables && disposables.dispose();
}
exports.deactivate = deactivate;
function serialize() {
    return state;
}
exports.serialize = serialize;
function consumeHaskellUpi(reg) {
    const tooltipOverride = new TooltipOverride_1.TooltipOverride(async (expression) => {
        if (debuggerInst === undefined) {
            return undefined;
        }
        return debuggerInst.resolveExpression(expression);
    });
    upi = reg({
        name: 'haskell-debug',
        tooltip: {
            priority: 100,
            handler: tooltipOverride.tooltipHandler.bind(tooltipOverride),
        },
    });
    return upi;
}
exports.consumeHaskellUpi = consumeHaskellUpi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUNBQXFDO0FBQ3JDLGlEQUE2QztBQUM3Qyx1REFBbUQ7QUFDbkQsZ0NBQStCO0FBQy9CLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0Isb0NBQW9DO0FBQ3BDLHFDQUFxQztBQUNyQyxxRUFBaUU7QUFFakUsbUNBQWlDO0FBQXhCLDBCQUFBLE1BQU0sQ0FBQTtBQUVmLE1BQU0sWUFBWSxHQUFHLElBQUksMkJBQVksRUFBRSxDQUFBO0FBRXZDLElBQUksWUFBa0MsQ0FBQTtBQUN0QyxJQUFJLEdBQWlDLENBQUE7QUFDckMsSUFBSSxLQUFvQyxDQUFBO0FBQ3hDLElBQUksV0FBb0QsQ0FBQTtBQUl4RCxNQUFNLFFBQVEsR0FBRztJQUNmLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxhQUFhLEVBQVEsRUFBRSxFQUFFO1FBQ3pDLE1BQU0sRUFBRSxHQUFHLEdBQUcsSUFBSSxNQUFNLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBbUIsbUJBQW1CLEVBQUUsU0FBUyxDQUFDLENBQUE7UUFDbEcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNQLFlBQVksR0FBRyxJQUFJLG1CQUFRLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUMsUUFBUSxFQUFFLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzFGLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLFlBQVksR0FBRyxJQUFJLG1CQUFRLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQTtRQUNqRixDQUFDO0lBQ0gsQ0FBQztJQUNELFlBQVksRUFBRSxHQUFHLEVBQUU7UUFDakIsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUNqQixZQUFZLENBQUMsSUFBSSxFQUFFLENBQUE7UUFDckIsQ0FBQztJQUNILENBQUM7SUFDRCxlQUFlLEVBQUUsR0FBRyxFQUFFO1FBQ3BCLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7WUFDakIsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQ3hCLENBQUM7SUFDSCxDQUFDO0lBQ0QsWUFBWSxFQUFFLEdBQUcsRUFBRTtRQUNqQixFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQTtRQUNyQixDQUFDO0lBQ0gsQ0FBQztJQUNELFlBQVksRUFBRSxHQUFHLEVBQUU7UUFDakIsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUNqQixZQUFZLENBQUMsSUFBSSxFQUFFLENBQUE7UUFDckIsQ0FBQztJQUNILENBQUM7SUFDRCxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7UUFDckIsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUNqQixZQUFZLENBQUMsUUFBUSxFQUFFLENBQUE7UUFDekIsQ0FBQztJQUNILENBQUM7SUFDRCxtQkFBbUIsRUFBRSxDQUFDLEVBQUUsYUFBYSxFQUFRLEVBQUUsRUFBRTtRQUMvQyxZQUFZLENBQUMsZ0JBQWdCLENBQzNCLGFBQWEsQ0FBQyxRQUFRLEVBQUUsQ0FBQyx1QkFBdUIsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLEVBQzFELGFBQWEsQ0FBQyxRQUFRLEVBQUUsQ0FDekIsQ0FBQTtJQUNILENBQUM7SUFDRCx3QkFBd0IsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNuQyxNQUFNLE1BQU0sR0FBRyxNQUFNLHlDQUFtQixDQUFDLG1CQUFVLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0NBQWdDLENBQUMsQ0FBQyxDQUFBO1FBQ3ZHLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0NBQWdDLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFBQyxDQUFDO0lBQ3pGLENBQUM7Q0FDRixDQUFBO0FBRUQ7SUFDRSxLQUFLLEdBQUc7UUFDTixpQkFBaUIsRUFBRSxLQUFLO0tBQ3pCLENBQUE7SUFHRCxNQUFNLEtBQUssR0FBRyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBQy9DLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUE7SUFFekMsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLENBQUE7SUFFcEMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtRQUN2QixFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVmLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDJCQUEyQixFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDLENBQUE7WUFDeEcsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFBQyxLQUFLLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFBO1lBQUMsQ0FBQztRQUMvQyxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBRUQsNEJBQTRCLElBQVk7SUFDdEMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLE1BQU0sRUFBRSxHQUE2RCxJQUFJLENBQUE7UUFDekUsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDLHNCQUFzQixFQUFFLENBQUMsY0FBYyxFQUFFLENBQUE7UUFDM0QsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLGdCQUFnQixDQUFDLENBQUMsQ0FBQztZQUMxRCxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUM7Z0JBQzlCLFlBQVksQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLENBQUMsQ0FBQTtnQkFDdEMsRUFBRSxDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQTtZQUNqQyxDQUFDO1lBQ0QsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztnQkFDakIsWUFBWSxDQUFDLFVBQVUsRUFBRSxDQUFBO1lBQzNCLENBQUM7WUFDRCxNQUFNLENBQUE7UUFDUixDQUFDO0lBQ0gsQ0FBQztJQUVELEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7UUFDakIsWUFBWSxDQUFDLFVBQVUsRUFBRSxDQUFBO0lBQzNCLENBQUM7QUFDSCxDQUFDO0FBTUQsa0JBQXlCLE1BQTBCO0lBQ2pELFdBQVcsR0FBRyxJQUFJLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxDQUFBO0lBQy9DLEtBQUssR0FBRyxNQUFNLENBQUE7SUFFZCxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssU0FBUyxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzVELFVBQVUsRUFBRSxDQUFBO0lBQ2QsQ0FBQztJQUNELFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxxQkFBcUIsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUE7SUFFekUsR0FBRyxDQUFDLENBQUMsTUFBTSxPQUFPLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUMsV0FBVyxDQUFDLEdBQUcsQ0FDYixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FDZixpREFBaUQsRUFDakQsVUFBVSxHQUFHLE9BQU8sRUFDcEIsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUNsQixDQUNGLENBQUE7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQWxCRCw0QkFrQkM7QUFFRDtJQUNFLFdBQVcsSUFBSSxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUE7QUFDdEMsQ0FBQztBQUZELGdDQUVDO0FBRUQ7SUFDRSxNQUFNLENBQUMsS0FBSyxDQUFBO0FBQ2QsQ0FBQztBQUZELDhCQUVDO0FBRUQsMkJBQWtDLEdBQXlCO0lBQ3pELE1BQU0sZUFBZSxHQUFHLElBQUksaUNBQWUsQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLEVBQUU7UUFDL0QsRUFBRSxDQUFDLENBQUMsWUFBWSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUMsU0FBUyxDQUFBO1FBQUMsQ0FBQztRQUNwRCxNQUFNLENBQUMsWUFBWSxDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFBO0lBQ25ELENBQUMsQ0FBQyxDQUFBO0lBQ0YsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNSLElBQUksRUFBRSxlQUFlO1FBQ3JCLE9BQU8sRUFBRTtZQUNQLFFBQVEsRUFBRSxHQUFHO1lBQ2IsT0FBTyxFQUFFLGVBQWUsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztTQUM5RDtLQUNGLENBQUMsQ0FBQTtJQUNGLE1BQU0sQ0FBQyxHQUFHLENBQUE7QUFDWixDQUFDO0FBYkQsOENBYUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEZWJ1Z2dlciB9IGZyb20gJy4vRGVidWdnZXInXG5pbXBvcnQgeyBCcmVha3BvaW50VUkgfSBmcm9tICcuL0JyZWFrcG9pbnRVSSdcbmltcG9ydCB7IFRvb2x0aXBPdmVycmlkZSB9IGZyb20gJy4vVG9vbHRpcE92ZXJyaWRlJ1xuaW1wb3J0ICogYXMgYXRvbUFQSSBmcm9tICdhdG9tJ1xuaW1wb3J0IG9zID0gcmVxdWlyZSgnb3MnKVxuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbmltcG9ydCBjcCA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKVxuaW1wb3J0IHsgZGVidWdNb2RlcyB9IGZyb20gJy4vY29uZmlnJ1xuaW1wb3J0IHsgc2VsZWN0RGVidWdNb2RlVmlldyB9IGZyb20gJy4vdmlld3MvU2VsZWN0RGVidWdNb2RlVmlldydcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuZXhwb3J0IHsgY29uZmlnIH0gZnJvbSAnLi9jb25maWcnXG5cbmNvbnN0IGJyZWFrcG9pbnRVSSA9IG5ldyBCcmVha3BvaW50VUkoKVxuXG5sZXQgZGVidWdnZXJJbnN0OiBEZWJ1Z2dlciB8IHVuZGVmaW5lZFxubGV0IHVwaTogVVBJLklVUElJbnN0YW5jZSB8IHVuZGVmaW5lZFxubGV0IHN0YXRlOiBIYXNrZWxsRGVidWdTdGF0ZSB8IHVuZGVmaW5lZFxubGV0IGRpc3Bvc2FibGVzOiBhdG9tQVBJLkNvbXBvc2l0ZURpc3Bvc2FibGUgfCB1bmRlZmluZWRcblxuZXhwb3J0IHR5cGUgVEVDRSA9IGF0b21BUEkuQ29tbWFuZEV2ZW50PGF0b21BUEkuVGV4dEVkaXRvckVsZW1lbnQ+XG5cbmNvbnN0IGNvbW1hbmRzID0ge1xuICAnZGVidWcnOiBhc3luYyAoeyBjdXJyZW50VGFyZ2V0IH06IFRFQ0UpID0+IHtcbiAgICBjb25zdCBvYiA9IHVwaSAmJiBhd2FpdCB1cGkuZ2V0T3RoZXJzQ29uZmlnUGFyYW08eyBuYW1lOiBzdHJpbmcgfT4oJ2lkZS1oYXNrZWxsLWNhYmFsJywgJ2J1aWxkZXInKVxuICAgIGlmIChvYikge1xuICAgICAgZGVidWdnZXJJbnN0ID0gbmV3IERlYnVnZ2VyKGJyZWFrcG9pbnRVSS5icmVha3BvaW50cywgY3VycmVudFRhcmdldC5nZXRNb2RlbCgpLCBvYi5uYW1lKVxuICAgIH0gZWxzZSB7XG4gICAgICBkZWJ1Z2dlckluc3QgPSBuZXcgRGVidWdnZXIoYnJlYWtwb2ludFVJLmJyZWFrcG9pbnRzLCBjdXJyZW50VGFyZ2V0LmdldE1vZGVsKCkpXG4gICAgfVxuICB9LFxuICAnZGVidWctYmFjayc6ICgpID0+IHtcbiAgICBpZiAoZGVidWdnZXJJbnN0KSB7XG4gICAgICBkZWJ1Z2dlckluc3QuYmFjaygpXG4gICAgfVxuICB9LFxuICAnZGVidWctZm9yd2FyZCc6ICgpID0+IHtcbiAgICBpZiAoZGVidWdnZXJJbnN0KSB7XG4gICAgICBkZWJ1Z2dlckluc3QuZm9yd2FyZCgpXG4gICAgfVxuICB9LFxuICAnZGVidWctc3RlcCc6ICgpID0+IHtcbiAgICBpZiAoZGVidWdnZXJJbnN0KSB7XG4gICAgICBkZWJ1Z2dlckluc3Quc3RlcCgpXG4gICAgfVxuICB9LFxuICAnZGVidWctc3RvcCc6ICgpID0+IHtcbiAgICBpZiAoZGVidWdnZXJJbnN0KSB7XG4gICAgICBkZWJ1Z2dlckluc3Quc3RvcCgpXG4gICAgfVxuICB9LFxuICAnZGVidWctY29udGludWUnOiAoKSA9PiB7XG4gICAgaWYgKGRlYnVnZ2VySW5zdCkge1xuICAgICAgZGVidWdnZXJJbnN0LmNvbnRpbnVlKClcbiAgICB9XG4gIH0sXG4gICd0b2dnbGUtYnJlYWtwb2ludCc6ICh7IGN1cnJlbnRUYXJnZXQgfTogVEVDRSkgPT4ge1xuICAgIGJyZWFrcG9pbnRVSS50b2dnbGVCcmVha3BvaW50KFxuICAgICAgY3VycmVudFRhcmdldC5nZXRNb2RlbCgpLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCkucm93ICsgMSxcbiAgICAgIGN1cnJlbnRUYXJnZXQuZ2V0TW9kZWwoKSxcbiAgICApXG4gIH0sXG4gICdzZXQtYnJlYWstb24tZXhjZXB0aW9uJzogYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlbGVjdERlYnVnTW9kZVZpZXcoZGVidWdNb2RlcywgYXRvbS5jb25maWcuZ2V0KCdoYXNrZWxsLWRlYnVnLmJyZWFrT25FeGNlcHRpb24nKSlcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHsgYXRvbS5jb25maWcuc2V0KCdoYXNrZWxsLWRlYnVnLmJyZWFrT25FeGNlcHRpb24nLCByZXN1bHQpIH1cbiAgfSxcbn1cblxuZnVuY3Rpb24gb25GaXJzdFJ1bigpIHtcbiAgc3RhdGUgPSB7XG4gICAgcHJvcGVybHlBY3RpdmF0ZWQ6IGZhbHNlLFxuICB9XG5cbiAgLy8gZnJvbSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzM0OTUzMTY4L25vZGUtY2hlY2stZXhpc3RlbmNlLW9mLWNvbW1hbmQtaW4tcGF0aFxuICBjb25zdCBpc1dpbiA9IG9zLnBsYXRmb3JtKCkuaW5kZXhPZignd2luJykgPiAtMVxuICBjb25zdCB3aGVyZSA9IGlzV2luID8gJ3doZXJlJyA6ICd3aGVyZWlzJ1xuXG4gIGNvbnN0IG91dCA9IGNwLmV4ZWMod2hlcmUgKyAnIG5vZGUnKVxuXG4gIG91dC5vbignY2xvc2UnLCAoY29kZSkgPT4ge1xuICAgIGlmIChjb2RlID09PSAxKSB7Ly8gbm90IGZvdW5kXG4gICAgICAvLyBmYWxsYmFjayB0byB0aGUgbm9kZSBpbiBhcG1cbiAgICAgIGF0b20uY29uZmlnLnNldCgnaGFza2VsbC1kZWJ1Zy5ub2RlQ29tbWFuZCcsIHBhdGgucmVzb2x2ZShhdG9tLnBhY2thZ2VzLmdldEFwbVBhdGgoKSwgJy4uLy4uL2Jpbi9hdG9tJykpXG4gICAgICBpZiAoc3RhdGUpIHsgc3RhdGUucHJvcGVybHlBY3RpdmF0ZWQgPSB0cnVlIH1cbiAgICB9XG4gIH0pXG59XG5cbmZ1bmN0aW9uIGFjdGl2ZVBhbmVPYnNlcnZlcihwYW5lOiBvYmplY3QpIHtcbiAgaWYgKGF0b20ud29ya3NwYWNlLmlzVGV4dEVkaXRvcihwYW5lKSkge1xuICAgIGNvbnN0IHRlOiBhdG9tQVBJLlRleHRFZGl0b3IgJiB7IGhhc0hhc2tlbGxCcmVha3BvaW50cz86IGJvb2xlYW4gfSA9IHBhbmVcbiAgICBjb25zdCBzY29wZXMgPSB0ZS5nZXRSb290U2NvcGVEZXNjcmlwdG9yKCkuZ2V0U2NvcGVzQXJyYXkoKVxuICAgIGlmIChzY29wZXMubGVuZ3RoID09PSAxICYmIHNjb3Blc1swXSA9PT0gJ3NvdXJjZS5oYXNrZWxsJykge1xuICAgICAgaWYgKCF0ZS5oYXNIYXNrZWxsQnJlYWtwb2ludHMpIHtcbiAgICAgICAgYnJlYWtwb2ludFVJLmF0dGFjaFRvTmV3VGV4dEVkaXRvcih0ZSlcbiAgICAgICAgdGUuaGFzSGFza2VsbEJyZWFrcG9pbnRzID0gdHJ1ZVxuICAgICAgfVxuICAgICAgaWYgKGRlYnVnZ2VySW5zdCkge1xuICAgICAgICBkZWJ1Z2dlckluc3Quc2hvd1BhbmVscygpXG4gICAgICB9XG4gICAgICByZXR1cm4gIC8vIGRvbid0IGRvIGJlbG93XG4gICAgfVxuICB9XG4gIC8vIGlmIGFueSBwYW5lIHRoYXQgaXNuJ3QgYSBoYXNrZWxsIHNvdXJjZSBmaWxlIGFuZCB3ZSdyZSBkZWJ1Z2dpbmdcbiAgaWYgKGRlYnVnZ2VySW5zdCkge1xuICAgIGRlYnVnZ2VySW5zdC5oaWRlUGFuZWxzKClcbiAgfVxufVxuXG5pbnRlcmZhY2UgSGFza2VsbERlYnVnU3RhdGUge1xuICBwcm9wZXJseUFjdGl2YXRlZDogYm9vbGVhblxufVxuXG5leHBvcnQgZnVuY3Rpb24gYWN0aXZhdGUoX3N0YXRlPzogSGFza2VsbERlYnVnU3RhdGUpIHtcbiAgZGlzcG9zYWJsZXMgPSBuZXcgYXRvbUFQSS5Db21wb3NpdGVEaXNwb3NhYmxlKClcbiAgc3RhdGUgPSBfc3RhdGVcblxuICBpZiAoc3RhdGUgPT09IHVuZGVmaW5lZCB8fCBzdGF0ZS5wcm9wZXJseUFjdGl2YXRlZCAhPT0gdHJ1ZSkge1xuICAgIG9uRmlyc3RSdW4oKVxuICB9XG4gIGRpc3Bvc2FibGVzLmFkZChhdG9tLndvcmtzcGFjZS5vYnNlcnZlQWN0aXZlUGFuZUl0ZW0oYWN0aXZlUGFuZU9ic2VydmVyKSlcblxuICBmb3IgKGNvbnN0IGNvbW1hbmQgb2YgT2JqZWN0LmtleXMoY29tbWFuZHMpKSB7XG4gICAgZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgYXRvbS5jb21tYW5kcy5hZGQoXG4gICAgICAgIFwiYXRvbS10ZXh0LWVkaXRvcltkYXRhLWdyYW1tYXI9J3NvdXJjZSBoYXNrZWxsJ11cIixcbiAgICAgICAgJ2hhc2tlbGw6JyArIGNvbW1hbmQsXG4gICAgICAgIGNvbW1hbmRzW2NvbW1hbmRdLFxuICAgICAgKSxcbiAgICApXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlYWN0aXZhdGUoKSB7XG4gIGRpc3Bvc2FibGVzICYmIGRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2VyaWFsaXplKCkge1xuICByZXR1cm4gc3RhdGVcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnN1bWVIYXNrZWxsVXBpKHJlZzogVVBJLklVUElSZWdpc3RyYXRpb24pIHtcbiAgY29uc3QgdG9vbHRpcE92ZXJyaWRlID0gbmV3IFRvb2x0aXBPdmVycmlkZShhc3luYyAoZXhwcmVzc2lvbikgPT4ge1xuICAgIGlmIChkZWJ1Z2dlckluc3QgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkIH1cbiAgICByZXR1cm4gZGVidWdnZXJJbnN0LnJlc29sdmVFeHByZXNzaW9uKGV4cHJlc3Npb24pXG4gIH0pXG4gIHVwaSA9IHJlZyh7XG4gICAgbmFtZTogJ2hhc2tlbGwtZGVidWcnLFxuICAgIHRvb2x0aXA6IHtcbiAgICAgIHByaW9yaXR5OiAxMDAsXG4gICAgICBoYW5kbGVyOiB0b29sdGlwT3ZlcnJpZGUudG9vbHRpcEhhbmRsZXIuYmluZCh0b29sdGlwT3ZlcnJpZGUpLFxuICAgIH0sXG4gIH0pXG4gIHJldHVybiB1cGlcbn1cbiJdfQ==